<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inpainting Mask Canvas Test</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            padding: 20px;
            font-family: 'Roboto', sans-serif;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .test-button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .test-button:hover {
            background-color: #0077dd;
        }

        .test-image {
            max-width: 300px;
            margin: 20px;
            border: 2px solid #666;
            border-radius: 8px;
        }

        .result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #333;
            border-radius: 8px;
            color: #fff;
            display: none;
        }

        .result-container h3 {
            margin-top: 0;
            color: #0066cc;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0066cc;
            text-decoration: none;
            font-size: 16px;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Main App</a>

    <div class="test-container">
        <h1>Inpainting Mask Canvas Test</h1>
        <p>This is a test page for the inpainting mask canvas functionality.</p>
        <p>Click the button below to test the mask canvas with a sample image.</p>

        <img src="{{ url_for('static', filename='images/0xmanga/0000000296-ai-generated_0_2_john_kafka_0_.png') }}"
            alt="Test Image" class="test-image" id="test-image">

        <br>

        <button class="test-button" onclick="testInpaintingCanvas()">
            üé® Open Mask Canvas
        </button>

        <button class="test-button" onclick="testWithLocalImage()">
            üñºÔ∏è Test with Local Image
        </button>
        
        <button class="test-button" onclick="testBrushEngine()">
            üñåÔ∏è Test Brush Engine
        </button>
        
        <button class="test-button" onclick="testPaintEraseTools()">
            üé® Test Paint/Erase Tools
        </button>

        <div id="result" class="result-container">
            <h3>Result:</h3>
            <p id="result-text"></p>
            <div id="mask-preview" style="margin-top: 10px;"></div>
        </div>

        <div style="margin-top: 30px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
            <h3>Instructions:</h3>
            <ul>
                <li><strong>Paint Tool:</strong> Click and drag to paint mask areas (white)</li>
                <li><strong>Erase Tool:</strong> Click and drag to erase mask areas (black)</li>
                <li><strong>Brush Size:</strong> Use the slider to adjust brush size</li>
                <li><strong>Keyboard Shortcuts:</strong>
                    <ul>
                        <li>Escape - Cancel and close</li>
                        <li>P - Switch to Paint tool</li>
                        <li>E - Switch to Erase tool</li>
                        <li>[ - Decrease brush size</li>
                        <li>] - Increase brush size</li>
                        <li>Ctrl+Z - Undo (placeholder)</li>
                        <li>Ctrl+Shift+Z - Redo (placeholder)</li>
                    </ul>
                </li>
                <li><strong>Complete:</strong> Click the green "Complete" button to finish</li>
                <li><strong>Cancel:</strong> Click the red "Cancel" button to abort</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { InpaintingMaskCanvas } from '{{ url_for("static", filename="js/inpainting-mask-canvas.js") }}';

        window.testInpaintingCanvas = async function () {
            const imageUrl = document.getElementById('test-image').src;
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('result-text');
            const maskPreview = document.getElementById('mask-preview');

            const canvas = new InpaintingMaskCanvas({
                imageUrl: imageUrl,
                containerElement: document.body,
                onMaskComplete: (maskDataUrl) => {
                    resultDiv.style.display = 'block';
                    resultText.textContent = `‚úÖ Mask completed successfully! Data URL length: ${maskDataUrl.length} characters`;

                    // Show a preview of the mask
                    maskPreview.innerHTML = `
                        <h4>Mask Preview:</h4>
                        <img src="${maskDataUrl}" style="max-width: 200px; border: 1px solid #666; border-radius: 4px;" alt="Generated Mask">
                    `;

                    console.log('Mask completed:', maskDataUrl);
                },
                onCancel: () => {
                    resultDiv.style.display = 'block';
                    resultText.textContent = '‚ùå Mask editing was cancelled.';
                    maskPreview.innerHTML = '';
                    console.log('Mask editing cancelled');
                }
            });

            try {
                // Show loading state
                resultDiv.style.display = 'block';
                resultText.textContent = '‚è≥ Loading image...';
                maskPreview.innerHTML = '';

                await canvas.show();

                // Hide loading state
                resultDiv.style.display = 'none';
            } catch (error) {
                resultDiv.style.display = 'block';
                resultText.textContent = `‚ùå Error opening canvas: ${error.message}`;
                console.error('Error opening canvas:', error);
            }
        };

        window.testWithLocalImage = function () {
            // Create a file input for testing with local images
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            fileInput.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imageUrl = e.target.result;

                        const canvas = new InpaintingMaskCanvas({
                            imageUrl: imageUrl,
                            containerElement: document.body,
                            onMaskComplete: (maskDataUrl) => {
                                const resultDiv = document.getElementById('result');
                                const resultText = document.getElementById('result-text');
                                const maskPreview = document.getElementById('mask-preview');

                                resultDiv.style.display = 'block';
                                resultText.textContent = `‚úÖ Mask completed for local image! Data URL length: ${maskDataUrl.length} characters`;

                                maskPreview.innerHTML = `
                                    <h4>Mask Preview:</h4>
                                    <img src="${maskDataUrl}" style="max-width: 200px; border: 1px solid #666; border-radius: 4px;" alt="Generated Mask">
                                `;

                                console.log('Mask completed for local image:', maskDataUrl);
                            },
                            onCancel: () => {
                                const resultDiv = document.getElementById('result');
                                const resultText = document.getElementById('result-text');
                                const maskPreview = document.getElementById('mask-preview');

                                resultDiv.style.display = 'block';
                                resultText.textContent = '‚ùå Mask editing was cancelled.';
                                maskPreview.innerHTML = '';
                                console.log('Mask editing cancelled');
                            }
                        });

                        canvas.show();
                    };
                    reader.readAsDataURL(file);
                }

                // Clean up
                document.body.removeChild(fileInput);
            };

            document.body.appendChild(fileInput);
            fileInput.click();
        };
        
        window.testBrushEngine = function() {
            // Test the brush engine directly
            import('{{ url_for("static", filename="js/brush-engine.js") }}').then(({ BrushEngine }) => {
                const resultDiv = document.getElementById('result');
                const resultText = document.getElementById('result-text');
                const maskPreview = document.getElementById('mask-preview');
                
                resultDiv.style.display = 'block';
                resultText.textContent = 'üß™ Testing Brush Engine...';
                
                try {
                    // Create a test mask
                    const width = 100;
                    const height = 100;
                    const maskData = new Uint8Array(width * height);
                    
                    // Create brush engine
                    const engine = new BrushEngine({ size: 20, mode: 'paint' });
                    
                    // Test single stamp
                    const hasChanges = engine.applyStamp(maskData, width, height, 50, 50, 20, 'paint');
                    
                    // Validate binary invariant
                    const isValid = BrushEngine.validateBinaryMask(maskData);
                    
                    // Count painted pixels
                    let paintedPixels = 0;
                    for (let i = 0; i < maskData.length; i++) {
                        if (maskData[i] === 255) paintedPixels++;
                    }
                    
                    // Create preview canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.maxWidth = '200px';
                    canvas.style.border = '1px solid #666';
                    canvas.style.borderRadius = '4px';
                    canvas.style.imageRendering = 'pixelated';
                    
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.createImageData(width, height);
                    
                    // Convert mask to RGBA
                    for (let i = 0; i < maskData.length; i++) {
                        const pixelIndex = i * 4;
                        const value = maskData[i];
                        imageData.data[pixelIndex] = value;     // R
                        imageData.data[pixelIndex + 1] = value; // G
                        imageData.data[pixelIndex + 2] = value; // B
                        imageData.data[pixelIndex + 3] = 255;   // A
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    resultText.textContent = `‚úÖ Brush Engine Test Results:
‚Ä¢ Changes detected: ${hasChanges}
‚Ä¢ Binary invariant valid: ${isValid}
‚Ä¢ Painted pixels: ${paintedPixels}
‚Ä¢ Circular stamp applied successfully!`;
                    
                    maskPreview.innerHTML = '<h4>Brush Test Result:</h4>';
                    maskPreview.appendChild(canvas);
                    
                } catch (error) {
                    resultText.textContent = `‚ùå Brush Engine Test Failed: ${error.message}`;
                    console.error('Brush engine test error:', error);
                }
            }).catch(error => {
                const resultDiv = document.getElementById('result');
                const resultText = document.getElementById('result-text');
                resultDiv.style.display = 'block';
                resultText.textContent = `‚ùå Failed to load brush engine: ${error.message}`;
            });
        };
        
        window.testPaintEraseTools = function() {
            // Test paint and erase functionality
            import('{{ url_for("static", filename="js/brush-engine.js") }}').then(({ BrushEngine }) => {
                const resultDiv = document.getElementById('result');
                const resultText = document.getElementById('result-text');
                const maskPreview = document.getElementById('mask-preview');
                
                resultDiv.style.display = 'block';
                resultText.textContent = 'üé® Testing Paint and Erase Tools...';
                
                try {
                    // Create test mask data
                    const width = 100;
                    const height = 100;
                    const maskData = new Uint8Array(width * height);
                    
                    // Create brush engine
                    const engine = new BrushEngine({ size: 20, mode: 'paint' });
                    
                    // Test paint tool (should stamp white/255 values)
                    engine.updateSettings({ mode: 'paint' });
                    const paintResult = engine.applyStamp(maskData, width, height, 30, 30, 20, 'paint');
                    
                    // Count painted pixels
                    let paintedPixels = 0;
                    for (let i = 0; i < maskData.length; i++) {
                        if (maskData[i] === 255) paintedPixels++;
                    }
                    
                    // Test erase tool (should stamp black/0 values)
                    engine.updateSettings({ mode: 'erase' });
                    const eraseResult = engine.applyStamp(maskData, width, height, 30, 30, 15, 'erase');
                    
                    // Count remaining painted pixels after erase
                    let remainingPixels = 0;
                    for (let i = 0; i < maskData.length; i++) {
                        if (maskData[i] === 255) remainingPixels++;
                    }
                    
                    // Test brush size range (1-200)
                    const testSizes = [1, 50, 100, 200];
                    const sizeResults = testSizes.map(size => {
                        const testMask = new Uint8Array(200 * 200);
                        engine.updateSettings({ size });
                        const hasChanges = engine.applyStamp(testMask, 200, 200, 100, 100, size, 'paint');
                        
                        let pixelCount = 0;
                        for (let i = 0; i < testMask.length; i++) {
                            if (testMask[i] === 255) pixelCount++;
                        }
                        
                        return { size, hasChanges, pixelCount };
                    });
                    
                    // Validate binary invariant
                    const isValid = BrushEngine.validateBinaryMask(maskData);
                    
                    // Create visual preview
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.maxWidth = '200px';
                    canvas.style.border = '1px solid #666';
                    canvas.style.borderRadius = '4px';
                    canvas.style.imageRendering = 'pixelated';
                    
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.createImageData(width, height);
                    
                    // Convert mask to RGBA for display
                    for (let i = 0; i < maskData.length; i++) {
                        const pixelIndex = i * 4;
                        const value = maskData[i];
                        imageData.data[pixelIndex] = value;     // R
                        imageData.data[pixelIndex + 1] = value; // G
                        imageData.data[pixelIndex + 2] = value; // B
                        imageData.data[pixelIndex + 3] = 255;   // A
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Create size test visualization
                    const sizeCanvas = document.createElement('canvas');
                    sizeCanvas.width = 400;
                    sizeCanvas.height = 100;
                    sizeCanvas.style.maxWidth = '400px';
                    sizeCanvas.style.border = '1px solid #666';
                    sizeCanvas.style.borderRadius = '4px';
                    sizeCanvas.style.imageRendering = 'pixelated';
                    
                    const sizeCtx = sizeCanvas.getContext('2d');
                    sizeCtx.fillStyle = '#333';
                    sizeCtx.fillRect(0, 0, 400, 100);
                    
                    // Draw circles for different brush sizes
                    sizeCtx.fillStyle = '#fff';
                    testSizes.forEach((size, index) => {
                        const x = 50 + index * 80;
                        const y = 50;
                        sizeCtx.beginPath();
                        sizeCtx.arc(x, y, size / 2, 0, Math.PI * 2);
                        sizeCtx.fill();
                        
                        sizeCtx.fillStyle = '#ccc';
                        sizeCtx.font = '12px Arial';
                        sizeCtx.textAlign = 'center';
                        sizeCtx.fillText(`${size}px`, x, y + size/2 + 15);
                        sizeCtx.fillStyle = '#fff';
                    });
                    
                    resultText.textContent = `‚úÖ Paint/Erase Tools Test Results:
‚Ä¢ Paint tool: ${paintResult ? 'Working' : 'Failed'} (${paintedPixels} pixels painted)
‚Ä¢ Erase tool: ${eraseResult ? 'Working' : 'Failed'} (${remainingPixels} pixels remaining)
‚Ä¢ Binary invariant: ${isValid ? 'Valid' : 'Invalid'}
‚Ä¢ Size range tests: ${sizeResults.every(r => r.hasChanges) ? 'All passed' : 'Some failed'}`;
                    
                    maskPreview.innerHTML = '<h4>Paint/Erase Test Results:</h4>';
                    
                    const paintEraseDiv = document.createElement('div');
                    paintEraseDiv.innerHTML = '<p><strong>Paint then Erase Test:</strong></p>';
                    paintEraseDiv.appendChild(canvas);
                    maskPreview.appendChild(paintEraseDiv);
                    
                    const sizeDiv = document.createElement('div');
                    sizeDiv.innerHTML = '<p><strong>Brush Size Range Test (1px, 50px, 100px, 200px):</strong></p>';
                    sizeDiv.appendChild(sizeCanvas);
                    maskPreview.appendChild(sizeDiv);
                    
                    // Add detailed results
                    const detailsDiv = document.createElement('div');
                    detailsDiv.style.marginTop = '10px';
                    detailsDiv.style.fontSize = '12px';
                    detailsDiv.style.color = '#ccc';
                    detailsDiv.innerHTML = `
                        <p><strong>Size Test Details:</strong></p>
                        ${sizeResults.map(r => `<p>Size ${r.size}px: ${r.pixelCount} pixels painted</p>`).join('')}
                    `;
                    maskPreview.appendChild(detailsDiv);
                    
                } catch (error) {
                    resultText.textContent = `‚ùå Paint/Erase Tools Test Failed: ${error.message}`;
                    console.error('Paint/erase tools test error:', error);
                }
            }).catch(error => {
                const resultDiv = document.getElementById('result');
                const resultText = document.getElementById('result-text');
                resultDiv.style.display = 'block';
                resultText.textContent = `‚ùå Failed to load brush engine: ${error.message}`;
            });
        };
    </script>
</body>

</html>